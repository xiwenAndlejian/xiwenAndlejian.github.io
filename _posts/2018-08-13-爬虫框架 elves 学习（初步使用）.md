---
layout: post
title:  '爬虫框架 elves 学习（初步使用）'
tags:
  - java
  - elves
  - 爬虫
hero: https://source.unsplash.com/collection/430471/
overlay: red
published: true

---
初识 elves，阅读示例代码&解析相关代码功能
{: .lead}
<!–-break-–>
## 爬虫框架 elves 学习（初步使用）

[框架地址][https://github.com/biezhi/elves]

我们可以参照在项目中的几个[例子](https://github.com/biezhi/elves/tree/master/src/test/java/io/github/biezhi/elves/examples)来学习

### 例子：爬取糗事百科段子

#### 源码&部分代码解析

```java
public class QiubaiExample {

    // 爬取的网页，也可以叫做根网页
    private static final String BASE_URL = "https://www.qiushibaike.com";

    @Slf4j
    static class QiubaiSpider extends Spider {
        public QiubaiSpider(String name) {
            super(name);
            this.startUrls(BASE_URL);
        }

        @Override
        public void onStart(Config config) {
            // 可以在此处对 config 设置自定义的读取超时、请求间隔、线程数、用户代理（模拟浏览器访问）

            // 类似于责任链的方式？通过增加一级一级的处理链，将请求&返回的响应进行分层处理
            // 此处 items 为 parse 方法返回的 result 中的 items
            // request 为响应内容的中的 request
            this.addPipeline((Pipeline<List<String>>) (items, request) -> {
                log.info("=== 段子来了 ===");
                items.forEach(item -> System.out.println("\r\n" + item + "\r\n============END==========\r\n"));
            });
        }

        @Override
        protected Result parse(Response response) {
            Result<List<String>> result = new Result<>();

            // 这里的 css 方法实际是使用了 jsoup 的 select 可以参照 https://jsoup.org/cookbook/extracting-data/selector-syntax
            List<String> items = response.body().css("#content-left div.article div.content span").stream()
                    .map(element -> element.text().replace("<br/>", "\r\n"))
                    .collect(Collectors.toList());

            result.setItem(items);

            // 下一页
            Optional<Element> nextEl = response.body().css("ul.pagination a span").stream()
                    .filter(element -> "下一页".equals(element.text()))
                    .map(Element::parent)
                    .findFirst();
            if (nextEl.isPresent()) {
                String          nextPageUrl = BASE_URL + nextEl.get().attr("href");
                Request<String> nextReq     = QiubaiSpider.this.makeRequest(nextPageUrl, this::parse);
                // 将接下来需要处理的请求放入 result 的 requests 列表中，该列表会在解析方法执行后，保存到调度器的队列中
                result.addRequest(nextReq);
            }
            return result;
        }
    }

    public static void main(String[] args) {
        QiubaiSpider qiubaiSpider = new QiubaiSpider("糗事百科");
        Elves.me(qiubaiSpider, Config.me().delay(2000)).start();
    }

}
```




